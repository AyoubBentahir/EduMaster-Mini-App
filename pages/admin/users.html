<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduMaster | Gestion Utilisateurs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="../../assets/js/utils.js"></script>
    <style>
        body {
            padding-left: 16rem;
        }
    </style>
</head>

<body>
    <aside id="sidebar"></aside>

    <main class="min-h-screen p-8 bg-slate-50">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">Gestion des Utilisateurs</h1>
                <p class="text-slate-500 mt-1">Administrez l'ensemble des comptes de la plateforme</p>
            </div>
            <button onclick="openUserModal()"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all flex items-center gap-2 transform hover:-translate-y-0.5">
                <i class="fas fa-plus"></i> Nouvel Utilisateur
            </button>
        </header>

        <!-- Filters -->
        <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 mb-6 flex gap-4 items-center">
            <div class="relative flex-1">
                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="search-user" placeholder="Rechercher par nom ou email..."
                    class="w-full pl-11 pr-4 py-2 bg-slate-50 border-none rounded-xl focus:ring-2 focus:ring-indigo-500 transition-all placeholder-slate-400 font-medium">
            </div>
            <select id="filter-role"
                class="bg-slate-50 border-none rounded-xl px-4 py-2 font-bold text-slate-600 focus:ring-2 focus:ring-indigo-500 cursor-pointer">
                <option value="ALL">Tous les rôles</option>
                <option value="ROLE_ADMIN">Administrateurs</option>
                <option value="ROLE_TEACHER">Enseignants</option>
                <option value="ROLE_STUDENT">Étudiants</option>
            </select>
            <button onclick="exportUsers()"
                class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded-xl font-bold shadow-lg shadow-emerald-200 transition-all flex items-center gap-2">
                <i class="fas fa-file-csv"></i> Export CSV
            </button>
        </div>

        <!-- Users Table -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr
                        class="bg-slate-50 text-slate-500 text-xs uppercase tracking-wider font-bold border-b border-slate-100">
                        <th class="p-6 cursor-pointer hover:bg-slate-100 transition" onclick="sortTable('firstname')">
                            <div class="flex items-center gap-2">
                                Utilisateur
                                <i class="fas fa-sort text-slate-300"></i>
                            </div>
                        </th>
                        <th class="p-6 cursor-pointer hover:bg-slate-100 transition" onclick="sortTable('role')">
                            <div class="flex items-center gap-2">
                                Rôle
                                <i class="fas fa-sort text-slate-300"></i>
                            </div>
                        </th>
                        <th class="p-6 cursor-pointer hover:bg-slate-100 transition" onclick="sortTable('createdAt')">
                            <div class="flex items-center gap-2">
                                Date d'inscription
                                <i class="fas fa-sort text-slate-300"></i>
                            </div>
                        </th>
                        <th class="p-6 cursor-pointer hover:bg-slate-100 transition" onclick="sortTable('isActive')">
                            <div class="flex items-center gap-2">
                                Statut
                                <i class="fas fa-sort text-slate-300"></i>
                            </div>
                        </th>
                        <th class="p-6 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table-body" class="divide-y divide-slate-100">
                    <!-- Loaded via JS -->
                </tbody>
            </table>
            <div id="empty-state" class="hidden p-12 text-center">
                <div
                    class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300 text-2xl">
                    <i class="fas fa-users-slash"></i>
                </div>
                <h3 class="text-slate-800 font-bold mb-1">Aucun utilisateur trouvé</h3>
                <p class="text-slate-400 text-sm">Essayez de modifier vos filtres de recherche.</p>
            </div>

            <!-- Pagination Controls -->
            <div id="pagination-controls"></div>
        </div>

    </main>

    <!-- Modal User -->
    <div id="user-modal"
        class="fixed inset-0 bg-slate-900/50 z-50 hidden flex items-center justify-center backdrop-blur-sm transition-all">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-8 transform transition-all scale-95 opacity-0"
            id="user-modal-content">
            <h3 class="text-2xl font-bold text-slate-800 mb-6" id="modal-title">Nouvel Utilisateur</h3>

            <form id="user-form" class="space-y-5">
                <input type="hidden" id="user-id">

                <div class="grid grid-cols-2 gap-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Prénom</label>
                        <input type="text" id="firstname" required
                            class="w-full px-4 py-3 bg-slate-50 rounded-xl border-none focus:ring-2 focus:ring-indigo-500 font-medium text-slate-700">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Nom</label>
                        <input type="text" id="lastname" required
                            class="w-full px-4 py-3 bg-slate-50 rounded-xl border-none focus:ring-2 focus:ring-indigo-500 font-medium text-slate-700">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Email</label>
                    <input type="email" id="email" required
                        class="w-full px-4 py-3 bg-slate-50 rounded-xl border-none focus:ring-2 focus:ring-indigo-500 font-medium text-slate-700">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Rôle</label>
                    <select id="role"
                        class="w-full px-4 py-3 bg-slate-50 rounded-xl border-none focus:ring-2 focus:ring-indigo-500 font-medium text-slate-700">
                        <option value="ROLE_ADMIN">Administrateur</option>
                        <option value="ROLE_TEACHER">Enseignant</option>
                        <option value="ROLE_STUDENT">Étudiant</option>
                    </select>
                </div>

                <div id="password-group">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Mot de passe</label>
                    <input type="text" id="password"
                        class="w-full px-4 py-3 bg-slate-50 rounded-xl border-none focus:ring-2 focus:ring-indigo-500 font-medium text-slate-700"
                        placeholder="Par défaut: password123">
                </div>

                <div class="flex items-center gap-3 pt-4">
                    <button type="button" onclick="closeUserModal()"
                        class="flex-1 px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50 transition">Annuler</button>
                    <button type="submit"
                        class="flex-1 px-4 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../../assets/js/data.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/layout.js"></script>
    <script>
        $(document).ready(function () {
            // Super Admin Only check removed here to allow Normal Admins to use this page for Teachers/Students
            // But we must restrict what they see.

            if (!window.auth.isAuthenticated()) window.location.href = '../../index.html';
            const currentUser = window.auth.currentUser;

            // Access Control
            if (currentUser.role !== 'ROLE_SUPER_ADMIN' && currentUser.role !== 'ROLE_ADMIN') {
                alert("Accès refusé");
                window.location.href = '../../index.html';
            }

            Layout.init('users');

            // Adjust Filters based on Role and URL Params
            const urlParams = new URLSearchParams(window.location.search);
            const statusParam = urlParams.get('role');
            if (statusParam) {
                if ($(`#filter-role option[value="${statusParam}"]`).length) {
                    $('#filter-role').val(statusParam);
                }
            }

            if (currentUser.role === 'ROLE_ADMIN') {
                // Normal Admin cannot see "Admins" option
                $('#filter-role option[value="ROLE_ADMIN"]').remove();
                $('#filter-role option[value="ALL"]').text('Enseignants & Étudiants');
            } else if (currentUser.role === 'ROLE_SUPER_ADMIN') {
                // Super Admin sees ONLY Admins, remove other options
                $('#filter-role option[value="ROLE_TEACHER"]').remove();
                $('#filter-role option[value="ROLE_STUDENT"]').remove();
                $('#filter-role option[value="ALL"]').text('Tous les Admins');
            }

            // Pagination and Sorting State
            let usersPagination = null;
            let currentSort = { key: 'firstname', direction: 'asc' };
            let allFilteredUsers = [];

            loadUsers();

            // Search & Filter
            $('#search-user, #filter-role').on('input change', function () {
                loadUsers();
            });

            // Sorting Function
            window.sortTable = function (key) {
                if (currentSort.key === key) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.key = key;
                    currentSort.direction = 'asc';
                }
                loadUsers();
            };

            // Export Function
            window.exportUsers = function () {
                if (allFilteredUsers.length === 0) {
                    if (window.notifications) {
                        window.notifications.warning('Aucun utilisateur à exporter');
                    } else {
                        alert('Aucun utilisateur à exporter');
                    }
                    return;
                }

                const exportData = allFilteredUsers.map(u => ({
                    Prénom: u.firstname,
                    Nom: u.lastname,
                    Email: u.email,
                    Rôle: u.role.replace('ROLE_', ''),
                    Statut: u.isActive ? 'Actif' : 'Inactif',
                    'Date Inscription': new Date(u.createdAt).toLocaleDateString('fr-FR')
                }));

                window.exportToCSV(exportData, `utilisateurs_${new Date().toISOString().split('T')[0]}.csv`);
            };

            function loadUsers() {
                const term = $('#search-user').val().toLowerCase();
                const roleFilter = $('#filter-role').val();

                let users = window.db.getAll('users');

                users = users.filter(u => {
                    // 1. SCOPE FILTER
                    if (currentUser.role === 'ROLE_ADMIN') {
                        // Normal Admin sees ONLY Teachers and Students
                        if (u.role === 'ROLE_SUPER_ADMIN' || u.role === 'ROLE_ADMIN') return false;
                    } else if (currentUser.role === 'ROLE_SUPER_ADMIN') {
                        // Super Admin sees ONLY normal Admins (not other Super Admins, not Teachers/Students)
                        if (u.role !== 'ROLE_ADMIN') return false;
                    }

                    // 2. SEARCH FILTER
                    const matchSearch = (u.firstname + ' ' + u.lastname + ' ' + u.email).toLowerCase().includes(term);

                    // 3. DROPDOWN FILTER
                    let matchRole = true;
                    if (roleFilter !== 'ALL') matchRole = (u.role === roleFilter);

                    return matchSearch && matchRole;
                });

                // Store filtered users for export
                allFilteredUsers = users;

                // Apply sorting
                users = window.sortData(users, currentSort.key, currentSort.direction);

                // Initialize pagination
                usersPagination = new window.Pagination(users, 10);

                // Get current page items
                const paginatedUsers = usersPagination.currentItems;

                const tbody = $('#users-table-body');
                tbody.empty();

                if (paginatedUsers.length === 0) {
                    $('#empty-state').removeClass('hidden');
                    $('#pagination-controls').hide();
                } else {
                    $('#empty-state').addClass('hidden');
                    $('#pagination-controls').show();

                    paginatedUsers.forEach(u => {
                        const avatar = `https://ui-avatars.com/api/?name=${u.firstname}+${u.lastname}&background=random&color=fff&size=40`;

                        let roleBadge = '';
                        if (u.role === 'ROLE_SUPER_ADMIN') roleBadge = '<span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-bold">Super Admin</span>';
                        if (u.role === 'ROLE_ADMIN') roleBadge = '<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">Admin</span>';
                        if (u.role === 'ROLE_TEACHER') roleBadge = '<span class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-bold">Enseignant</span>';
                        if (u.role === 'ROLE_STUDENT') roleBadge = '<span class="px-3 py-1 bg-slate-100 text-slate-600 rounded-full text-xs font-bold">Étudiant</span>';

                        const date = new Date(u.createdAt).toLocaleDateString('fr-FR');

                        const status = u.isActive
                            ? '<span class="w-3 h-3 rounded-full bg-green-500 inline-block mr-2"></span>Actif'
                            : '<span class="w-3 h-3 rounded-full bg-red-500 inline-block mr-2"></span>Inactif';

                        // ACTION BUTTONS LOGIC
                        let actions = '';
                        // Super Admin cannot be deleted/modified/disabled here (only edited via profile for himself)
                        if (u.role !== 'ROLE_SUPER_ADMIN') {
                            actions += `
                                <button onclick="editUser(${u.id})" class="w-8 h-8 rounded-lg bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-600 transition shadow-sm inline-flex items-center justify-center mr-2">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="toggleStatus(${u.id})" class="w-8 h-8 rounded-lg bg-white border border-slate-200 text-slate-400 hover:text-amber-600 hover:border-amber-600 transition shadow-sm inline-flex items-center justify-center mr-2" title="Activer/Désactiver">
                                    <i class="fas fa-power-off"></i>
                                </button>
                                <button onclick="deleteUser(${u.id})" class="w-8 h-8 rounded-lg bg-white border border-slate-200 text-slate-400 hover:text-red-600 hover:border-red-600 transition shadow-sm inline-flex items-center justify-center">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                        } else {
                            actions = '<span class="text-xs text-slate-300 italic">Protégé</span>';
                        }

                        const html = `
                            <tr class="group hover:bg-slate-50 transition-colors">
                                <td class="p-6">
                                    <div class="flex items-center gap-4">
                                        <img src="${avatar}" class="w-10 h-10 rounded-full shadow-sm" alt="Avatar">
                                        <div>
                                            <div class="font-bold text-slate-800">${u.firstname} ${u.lastname}</div>
                                            <div class="text-xs text-slate-400 font-mono">${u.email}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="p-6">${roleBadge}</td>
                                <td class="p-6 text-sm text-slate-500 font-medium">${date}</td>
                                <td class="p-6 text-sm text-slate-700 font-bold">${status}</td>
                                <td class="p-6 text-right">${actions}</td>
                            </tr>
                        `;
                        tbody.append(html);
                    });

                    // Render pagination controls
                    window.renderPaginationControls(usersPagination, 'pagination-controls', loadUsers);
                }
            }

            // MODAL LOGIC
            window.openUserModal = function (userId = null) {
                $('#user-modal').removeClass('hidden');
                setTimeout(() => $('#user-modal-content').removeClass('scale-95 opacity-0').addClass('scale-100 opacity-100'), 10);

                $('#user-form')[0].reset();
                $('#user-id').val('');

                // Adjust Role Options based on Creator
                const roleSelect = $('#role');
                roleSelect.empty();

                if (currentUser.role === 'ROLE_SUPER_ADMIN') {
                    // Super Admin creates ONLY normal Admins (not Super Admins, not Teachers/Students)
                    roleSelect.append('<option value="ROLE_ADMIN">Administrateur</option>');
                } else { // ROLE_ADMIN
                    // Normal Admin creates only Teachers and Students
                    roleSelect.append('<option value="ROLE_TEACHER">Enseignant</option>');
                    roleSelect.append('<option value="ROLE_STUDENT">Étudiant</option>');
                }

                if (userId) {
                    const u = window.db.getById('users', userId);
                    // Double check permission
                    if (u.role === 'ROLE_SUPER_ADMIN') { alert("Action interdite."); closeUserModal(); return; }
                    if (currentUser.role === 'ROLE_ADMIN' && u.role === 'ROLE_ADMIN') { alert("Action interdite."); closeUserModal(); return; }

                    $('#modal-title').text('Modifier Utilisateur');
                    $('#firstname').val(u.firstname);
                    $('#lastname').val(u.lastname);
                    $('#email').val(u.email);
                    $('#role').val(u.role); // This might fail if option not available, but logic above prevents editing higher roles
                    $('#user-id').val(u.id);
                    $('#password').val(u.password);
                } else {
                    $('#modal-title').text('Nouvel Utilisateur');
                    $('#password').val('password123');
                }
            }

            window.closeUserModal = function () {
                $('#user-modal-content').removeClass('scale-100 opacity-100').addClass('scale-95 opacity-0');
                setTimeout(() => $('#user-modal').addClass('hidden'), 300);
            }

            window.editUser = function (id) {
                openUserModal(id);
            }

            $('#user-form').on('submit', function (e) {
                e.preventDefault();
                const id = $('#user-id').val();

                const data = {
                    firstname: $('#firstname').val(),
                    lastname: $('#lastname').val(),
                    email: $('#email').val(),
                    role: $('#role').val(),
                    password: $('#password').val() || 'password123',
                    isActive: true
                };

                // Final backend-check simulation
                if (currentUser.role === 'ROLE_ADMIN') {
                    // Normal Admin cannot create Admins or Super Admins
                    if (data.role === 'ROLE_ADMIN' || data.role === 'ROLE_SUPER_ADMIN') {
                        alert("Vous ne pouvez pas créer ce type de compte.");
                        return;
                    }
                } else if (currentUser.role === 'ROLE_SUPER_ADMIN') {
                    // Super Admin can ONLY create normal Admins
                    if (data.role !== 'ROLE_ADMIN') {
                        alert("Vous ne pouvez créer que des comptes Administrateur.");
                        return;
                    }
                }

                if (id) {
                    window.db.update('users', id, data);
                } else {
                    window.db.add('users', data);
                }

                closeUserModal();
                loadUsers();
            });

            window.toggleStatus = function (id) {
                const u = window.db.getById('users', id);
                // Protection
                if (u.role === 'ROLE_SUPER_ADMIN') return;

                if (u) {
                    window.db.update('users', id, { isActive: !u.isActive });
                    loadUsers();
                }
            };

            window.deleteUser = function (id) {
                const u = window.db.getById('users', id);
                // Protection
                if (u.role === 'ROLE_SUPER_ADMIN') return;

                if (confirm('Supprimer définitivement cet utilisateur ?')) {
                    window.db.delete('users', id);
                    loadUsers();
                }
            };
        });
    </script>
</body>

</html>